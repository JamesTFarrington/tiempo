<!DOCTYPE html>
<html>
    <head>
        <title>Reelio Tiempo Dashboard</title>
        <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/angular_material/0.11.2/angular-material.min.css">

        <style type="text/css">
            .job.ng-animate {
                background-color: teal;
            }

            #errorContainer {
              position: absolute;
              right: 0;
            }
            .error {
              border: 2px solid red;
              margin-top: 10px;
              background-color: rgb(255, 233, 233);
            }

            .errorText {
              font-size:25px;
            }

            #kioskRowAreas {
            width:60%;
            }


        </style>

    </head>
    <body ng-app='app'>
        <md-toolbar>
            <div class='md-toolbar-tools'>
                <h1>Reelio - Tiempo</h1>
            </div>
        </md-toolbar>

        <div ng-controller='TiempoController' layout-padding>
            <div id="errorContainer">
                <div ng-repeat="error in tiempo.errors" class="error">
                    <h4>Error in job "[{error.codeWord}]"</h4>
                    <div>Path: [{error.message}]</div>
                    <div>Uid: [{error.jobUid}])</div>
                    <div class="errorText">[{error.error_message}]</div>
                </div>
            </div>

            <div layout='row' id="kioskRowAreas">
                <md-list flex='100' class='md-whiteframe-1dp'>

                    <!-- Runners -->

                    <md-list-item>
                        <div flex='100' layout='row' layout-align='space-around center'>
                            <div flex='10'>Runner</div>
                            <div flex='20'>Job Code Name</div>
                            <div flex='30'>Time</div>
                            <div flex='40'>Activity</div>
                        </div>
                    </md-list-item>


                    <div ng-repeat='(id, runner) in tiempo.runners'>
                        <md-divider></md-divider>
                        <md-list-item running-alert="runner.jobUid" error-state="runner.error">
                            <div flex='100'layout='row' layout-align='space-around center'>
                                <div flex='10'>[{id}]</div>
                                <div flex='20'>[{runner.codeWord}]</div>
                                <div flex='30'>
                                    <span am-time-ago="runner.time"></span>
                                </div>
                                <div flex='40'>[{runner.message}]</div>
                            </div>
                        </md-list-item>
                    </div>

                    <!-- Queue -->
                    <div ng-if="tiempo.jobs | jobsFilter">
                        <h2>Job Queue</h2>

                        <md-list-item>
                            <div flex='100' layout='row' layout-align='space-around center'>
                                <div flex='10'>Name</div>
                                <div flex='40'>Task Path</div>
                                <div flex='20'>Enqueued</div>
                                <div flex='20'>Group</div>
                            </div>
                        </md-list-item>

                        <div ng-repeat='(uid, job) in tiempo.jobs | jobsFilter' class="job" id="j[{uid}]">
                            <md-divider></md-divider>
                            <md-list-item>
                                <div flex='100'layout='row' layout-align='space-around center'>
                                    <div flex='10'>[{job.codeWord}]</div>
                                    <div flex='40'>[{job.key}]</div>
                                    <div flex='20'>
                                        <span am-time-ago="job.enqueued"</span>
                                    </div>
                                    <div flex='20'>[{job.group}]</div>
                                </div>
                            </md-list-item>
                        </div>
                    </div>

                    <!-- Tasks -->
                    <h2>Tasks</h2>

                    <md-list-item>
                        <div flex='100' layout='row' layout-align='space-around center'>
                            <div flex="20">Next Job</div>
                            <div flex='40'>Task path</div>
                            <div flex='40'>Next Run Time</div>
                        </div>
                    </md-list-item>

                    <div ng-repeat='(id, task) in tiempo.tasks'>
                        <md-divider></md-divider>
                        <md-list-item id="t[{task.uid}]">
                            <div flex='100'layout='row' layout-align='space-around center'>
                                <div flex="20">[{task.codeWord}]</div>
                                <div flex='30'>[{task.path}]</div>
                                <div flex='30'>[{task.id}]</div>
                                <div flex="20">
                                    <span am-time-ago="task.next_run_time"</span>
                                </div>
                            </div>
                        </md-list-item>
                    </div>

                </md-list>
            </div>
        </div>

        <!-- Javascript -->
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.6/angular.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.6/angular-animate.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.6/angular-aria.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angular_material/0.11.2/angular-material.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.0.3/sockjs.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-moment/1.0.0-beta.2/angular-moment.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.2.3/velocity.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.2.3/velocity.ui.min.js"></script>

        <script type="text/javascript">

            var tiempoKiosk = angular.module('app', [
                'ngAnimate',
                'ngMaterial',
                'TiempoController',
                'CustomInterpolation',
                'angularMoment',
                'tiempoFilters',
            ]);

            angular.module('CustomInterpolation', [])
            .config(function($interpolateProvider) {
                $interpolateProvider.startSymbol('[{');
                $interpolateProvider.endSymbol('}]');
            });

            angular.module('tiempoFilters', [])
                .filter('jobsFilter', function() {
                  return function(input, search) {
                    if (!input) return input;
                    var result = {};
                    angular.forEach(input, function(value, key) {
                        if (value.status == "queued") {
                            result[key] = value;
                        }
                    });
                    return result;
                  }
                });

            angular.module('TiempoController', [])
            .controller('TiempoController', function($scope){

                $scope.tiempo = {};

                var sock = new SockJS('/tiempo_communication/messages/');

                sock.onopen = function(e) {
                    sock.send(
                        JSON.stringify({'hx_subscribe': 'all_tasks'})
                    );
                    sock.send(
                        JSON.stringify({'hx_subscribe': 'job_queue'})
                    );
                    sock.send(
                        JSON.stringify({'hx_subscribe': 'runners'})
                    );
                    sock.send(
                        JSON.stringify({'hx_subscribe': 'errors'})
                    );
                    sock.send('updateJobs');
                };

                sock.onmessage = function(e) {

                    var message = JSON.parse(e.data);

                    // Just return if this is maintenance stuff.
                    if ("setup_connection" in message) {
                        return;
                    }

                    if ("message" in message && message.message.indexOf("<HTTPChannel") == 0) {
                        return;
                    }
                    ////// End connection maintainence.

                    var key = Object.keys(message); // Will be "runners" or "tasks" or something.
                    var objects = message[key]
                    // console.log("Received " + Object.keys(objects).length + " " + key);
                    // console.log(objects);

                    // Make sure we know about this type of object.
                    if (!(key in $scope.tiempo)) {
                        $scope.tiempo[key] = {};
                    }


                    // Take each object in the message and push it to a list of like objects.
                    for (var objectId in objects) {
                       $scope.tiempo[key][objectId] = objects[objectId];
                    }

                    $scope.$apply(); // Update the scope for every message on the socket.
                };

            });

            tiempoKiosk.directive('runningAlert', function($animate) {
              return function(scope, runnerElem, attr) {
                  scope.$watch(attr.errorState, function(nv, ov) {
                    if (nv) {
                      Velocity(runnerElem, { 'backgroundColor': '#FFE9E9' });
                      Velocity(runnerElem, "transition.slideRightBigOut");
                    }
                  })
                  scope.$watch(attr.runningAlert, function(nv, ov) {
                    if (nv) {
                        alertRunningSequence = false;
                        jobObj = scope.tiempo['jobs'][nv];
                        if (jobObj) {
                            jobElem = document.getElementById('j' + nv);
                            taskElem = document.getElementById('t' + jobObj.taskUid)
                            alertRunningSequence = [
                                { e: jobElem, p: {'backgroundColor': '#FF9900'}},
                                { e: taskElem, p: "alertRunning", o: { sequenceQueue: false}},
                                { e: jobElem, p: 'transition.slideUpOut', o: { sequenceQueue: false}},
                                { e: runnerElem, p: {'backgroundColor': '#FF9900'}, o: { sequenceQueue: false}},
                                { e: runnerElem, p: 'transition.slideUpIn', o: { sequenceQueue: false}},
                                { e: runnerElem, p: {'backgroundColor': '#fff'}, o: { sequenceQueue: false}},

                            ]
                        }
                    } else {
                        console.log("Job finished.");
                        alertRunningSequence = [
                        { e: runnerElem, p: 'transition.slideDownOut'},
                        ]

                    }
                    if (alertRunningSequence) {
                      Velocity.RunSequence(alertRunningSequence);
                    }
                  })
              }
            });

            tiempoKiosk.animation('.job', [function() {
                  return {
                    enter: function(element, doneFn) {
                        Velocity(element, "transition.flipBounceYIn");
                        Velocity(element, {backgroundColor: "#fff"}, {duration: 2000}).then(doneFn);
                    },
                  }
            }]);
            tiempoKiosk.animation('.error', [function() {
                  return {
                    enter: function(element, doneFn) {
                        Velocity(element, "transition.slideLeftBigIn");
                    },
                  }
            }]);



    Velocity.RegisterEffect("alertRunning", {
        calls: [
            [{'backgroundColor': '#FF9900'}, 0.001],
            ['callout.pulse'],
        ],
        reset: {'backgroundColor': '#fff'}
    })

        </script>
    </body>
</html>
