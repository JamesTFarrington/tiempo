<!DOCTYPE html>
<html>
    <head>
        <title>Reelio Tiempo Dashboard</title>
        <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/angular_material/0.11.2/angular-material.min.css">
    </head>
    <body ng-app='app'>
        <md-toolbar>
            <div class='md-toolbar-tools'>
                <h1>Reelio - Tiempo</h1>
            </div>
        </md-toolbar>

        <div ng-controller='TiempoController' layout-padding>
            <div layout='row'>
                <md-list flex='100' class='md-whiteframe-1dp'>
                    <md-list-item>
                        <div flex='100' layout='row' layout-align='space-around center'>
                            <div flex='10'>Queue</div>
                            <div flex='40'>Time</div>
                            <div flex='40'>Message</div>
                        </div>
                    </md-list-item>
                    <div ng-repeat='queue in queues'>
                        <md-divider></md-divider>
                        <md-list-item>
                            <div flex='100'layout='row' layout-align='space-around center'>
                                <div flex='10'>[{queue.queue}]</div>
                                <div flex='40'>[{queue.time | date:'short'}]</div>
                                <div flex='40'>[{queue.message}]</div>
                            </div>
                        </md-list-item>
                    </div>
                </md-list>
            </div>
        </div>

        <!-- Javascript -->
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular-animate.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular-aria.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angular_material/0.11.2/angular-material.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.0.3/sockjs.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js"></script>
        <script type="text/javascript">

            angular.module('CustomInterpolation', [])
            .config(function($interpolateProvider) {
                $interpolateProvider.startSymbol('[{');
                $interpolateProvider.endSymbol('}]');
            });

            angular.module('TiempoController', [])
            .controller('TiempoController', function($scope){

                var sock = new SockJS('192.168.1.145:8000/messages/main/');

                $scope.queues = [];

                sock.onopen = function(e) {
                    sock.send(
                        JSON.stringify({'hx_subscribe': 'all_tasks'})
                    );
                };

                sock.onmessage = function(e) {
                    var message = JSON.parse(e.data);
                    if('queue' in message){
                        var queueIndex = _.findIndex($scope.queues, function(obj){
                            return obj.queue == message.queue;
                        })
                        if(queueIndex == -1){
                            $scope.queues.push(message);
                        }
                        else{
                            $scope.queues[queueIndex] = message;
                        }
                        $scope.$apply()
                    }
                };

            });

            angular.module('app', [
                'ngMaterial',
                'TiempoController',
                'CustomInterpolation'
            ]);

        </script>
    </body>
</html>
