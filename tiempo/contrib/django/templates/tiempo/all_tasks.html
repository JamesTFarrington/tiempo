<!DOCTYPE html>
<html>
    <head>
        <title>Reelio Tiempo Dashboard</title>
        <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/angular_material/0.11.2/angular-material.min.css">
    </head>
    <body ng-app='app'>
        <md-toolbar>
            <div class='md-toolbar-tools'>
                <h1>Reelio - Tiempo</h1>
            </div>
        </md-toolbar>

        <div ng-controller='TiempoController' layout-padding>
            <div layout='row'>
                <md-list flex='100'>
                    <md-list-item>
                        <div flex='100' layout='row' layout-align='space-around center'>
                            <div>Time</div>
                            <div>Message</div>
                        </div>
                    </md-list-item>
                    <md-list-item ng-repeat='event in events'>
                        <div  flex='100'layout='row' layout-align='space-around center'>
                            <div>[{event.time | date:'short'}]</div>
                            <div>[{event.message}]</div>
                        </div>
                    </md-list-item>
                </md-list>
            </div>
        </div>

        <!-- Javascript -->
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular-animate.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular-aria.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angular_material/0.11.2/angular-material.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.0.3/sockjs.min.js"></script>
        <script type="text/javascript">

            angular.module('CustomInterpolation', [])
            .config(function($interpolateProvider) {
                $interpolateProvider.startSymbol('[{');
                $interpolateProvider.endSymbol('}]');
            });

            angular.module('TiempoController', [])
            .controller('TiempoController', function($scope){

                var sock = new SockJS('192.168.1.145:8000/messages/main/');

                $scope.events = [];

                sock.onopen = function(e) {
                    sock.send(
                        JSON.stringify({'hx_subscribe':'all_tasks'})
                    );
                };

                sock.onmessage = function(e) {
                    var message = JSON.parse(e.data);
                    if('time' in message){
                        $scope.events.push(message);
                        $scope.$apply()
                    }
                };

            });

            angular.module('app', [
                'ngMaterial',
                'TiempoController',
                'CustomInterpolation'
            ]);

        </script>
    </body>
</html>
